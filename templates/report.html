{% extends 'base.html' %}
{% block content %}
<div class="row g-3">
  <div class="col-md-4">
    <div class="card shadow-sm hover-rise gradient-brand">
      <div class="card-body">
        <h6 class="mb-3">User</h6>
        <div><strong>{{ user.name }}</strong></div>
        <div class="text-muted small">{{ user.gender or '-' }}, {{ user.age or '-' }} yrs</div>
        <div class="small text-monospace">ID: {{ user.userId }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-8">
    <div class="card shadow-sm hover-rise">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0">ML Model Prediction</h6>
          <span class="badge badge-chip {% if test.riskResult=='High' %}badge-high{% elif test.riskResult=='Medium' %}badge-med{% else %}badge-low{% endif %}">{{ test.riskResult }}</span>
        </div>
        {% if test.mlConfidence %}
        <div class="my-2">
          <small class="text-muted">Confidence: <strong>{{ "%.1f"|format(test.mlConfidence * 100) }}%</strong></small>
        </div>
        {% endif %}
        <div class="my-3">
          <canvas id="gaugeCanvas" height="180"></canvas>
        </div>
        
        {% if test.mlProbabilities %}
        <div class="mb-3">
          <h6>Probability Distribution</h6>
          <div class="progress mb-1" style="height: 20px;">
            <div class="progress-bar bg-success" style="width: {{ test.mlProbabilities.Low * 100 }}%">
              Low: {{ "%.0f"|format(test.mlProbabilities.Low * 100) }}%
            </div>
            <div class="progress-bar bg-warning" style="width: {{ test.mlProbabilities.Medium * 100 }}%">
              Medium: {{ "%.0f"|format(test.mlProbabilities.Medium * 100) }}%
            </div>
            <div class="progress-bar bg-danger" style="width: {{ test.mlProbabilities.High * 100 }}%">
              High: {{ "%.0f"|format(test.mlProbabilities.High * 100) }}%
            </div>
          </div>
        </div>
        {% endif %}
        
        <h6>Summary</h6>
        <div class="row g-2">
          {% for k, v in test.responses.items() %}
          <div class="col-6 small"><strong>{{ k }}</strong>: {{ v }}</div>
          {% endfor %}
        </div>
        <div class="mt-3 d-flex gap-2">
          <a class="btn btn-indigo" href="{{ url_for('download_report', testId=test.testId) }}">Download PDF</a>
          <a class="btn btn-outline-primary" href="{{ url_for('user_dashboard', userId=test.userId) }}">Back to Dashboard</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<script>
const risk = '{{ test.riskResult }}';
const map = {Low: 20, Medium: 60, High: 90};
const value = map[risk] || 20;
const remainder = 100 - value;
const colors = {
  High: ['#ef4444', '#fde2e2'],
  Medium: ['#f59e0b', '#fff1cf'],
  Low: ['#16a34a', '#dff7e8']
};
const ctx = document.getElementById('gaugeCanvas');
new Chart(ctx, {
  type: 'doughnut',
  data: { datasets: [{ data: [value, remainder], backgroundColor: [colors[risk]?.[0] || '#16a34a', colors[risk]?.[1] || '#e9ecef'], borderWidth: 0 }] },
  options: { rotation: -90, circumference: 180, cutout: '70%', plugins:{ legend:{display:false}, tooltip:{enabled:false} } }
});

// Confetti for Low risk
if (risk === 'Low') {
  setTimeout(() => {
    confetti({ particleCount: 90, spread: 70, origin: { y: 0.6 } });
  }, 300);
}
</script>
{% endblock %}


